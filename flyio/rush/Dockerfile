FROM alpine:3.18

ARG TARGETOS
ARG TARGETARCH
ARG USER=gorush
ENV HOME /home/$USER


ENV GORUSH_IOS_ENABLED=true

ENV GORUSH_ANDROID_ENABLED=true

ENV GORUSH_IOS_KEY_PATH="/keys/AuthKey_H7PMW927D3.p8"

ENV GORUSH_IOS_KEY_TYPE="p8"

##############

# ENV GORUSH_ANDROID_APIKEY="AAAAGyZUsVM:APA91bF3pXS9tnK-PW4w_zh22WGdrM6HgrDRMLCjZ07ha0tM50BHVT1hI8NJuOHN2sJUthOy4mOwFY7uHvGVK8dGSSk3yq_2fsd0ViqDtR01TxmoG9QOj8w1v0WrxN6lRXRU9iHnBTD0"
# ENV GORUSH_CORE_MAX_NOTIFICATION="100000000"
# ENV GORUSH_CORE_QUEUE_NUM="2000000"
# ENV GORUSH_CORE_SYNC="true"
# ENV GORUSH_IOS_KEY_ID="H7PMW927D3"
# ENV GORUSH_IOS_TEAM_ID="3733ZPWZ9T"
# ENV GORUSH_IOS_PRODUCTION="true"
# ENV GORUSH_IOS_MAX_CONCURRENT_PUSHES="100000"
# ENV GORUSH_LOG_HIDE_TOKEN="false"
# ENV GORUSH_LOG_ACCESS_LEVEL="info"
# ENV GORUSH_LOG_FORMAT="json"
# ENV GORUSH_LOG_ERROR_LEVEL="info"
##############

COPY ./keys /keys

# add new user
RUN adduser -D $USER
RUN apk add --no-cache ca-certificates mailcap && \
  rm -rf /var/cache/apk/*

COPY ./gorush /bin/

USER $USER
WORKDIR $HOME

EXPOSE 8088 9000
HEALTHCHECK --start-period=1s --interval=10s --timeout=5s \
  CMD ["/bin/gorush", "--ping"]

ENTRYPOINT ["/bin/gorush"]
